<!DOCTYPE html>
<html lang="en">
  <head>
    <title>LUSH SCENTES</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mukta:300,400,700"> 
    <link rel="stylesheet" href="fonts/icomoon/style.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/aos.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.all.min.js"></script>
  </head>

  <style>
    .product-image-zoom {
      position: relative;
      overflow: hidden;
      cursor: zoom-in;
    }
    
    .thumbnail-image {
      cursor: pointer;
      transition: opacity 0.3s;
    }
    
    .thumbnail-image:hover {
      opacity: 0.8;
    }
    
    .original-price {
      font-size: 1.1rem;
      margin-bottom: 0;
    }
    
   /* Offer Display Styles */
.offer-container {
  display: flex;
  flex-direction: column;
  background-color: #f8f9fa;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 12px 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.offer-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.offer-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #e83e8c; /* Match the theme's primary color */
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.offer-icon {
  font-size: 18px;
}

.offer-type {
  margin-top: 2px; /* Adjust for vertical alignment with the icon */
}

.offer-details {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
  font-size: 16px;
  color: #333;
}

.offer-name {
  font-weight: 500;
}

.offer-discount {
  font-weight: 700;
  color: #28a745; 
  background-color: #e6f4ea;
  padding: 2px 8px;
  border-radius: 4px;
}

.text-muted {
  font-size: 14px;
  color: #6c757d;
}
    .cursor-pointer {
      cursor: pointer;
    }

    .star-group {
      color: #ffc107;
      font-size: 24px;
      letter-spacing: 2px;
    }

    .star-group span:not(.filled) {
      color: #e4e5e9;
    }

    .form-check {
      cursor: pointer;
    }

    .form-check:hover .star-group {
      opacity: 0.8;
    }

    .btn-danger {
      background-color: #e83e8c;
      border-color: #e83e8c;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .btn-danger:hover {
      background-color: #d4337c;
      border-color: #d4337c;
    }

    .review-form-container {
      border: 1px solid #eee;
    }

    textarea.form-control {
      border-color: #eee;
      resize: none;
    }

    textarea.form-control:focus {
      border-color: #e83e8c;
      box-shadow: 0 0 0 0.25rem rgba(232, 62, 140, 0.25);
    }

    .review-card {
      transition: background-color 0.2s;
    }

    .review-card:hover {
      background-color: #f9f9f9;
    }

    h4 {
      font-weight: 600;
      color: #333;
    }

    .text-secondary {
      color: #6c757d !important;
    }
    #variant-stock.out-of-stock {
    color: #d9534f;
    font-weight: bold;
}
  </style>

  <body>
    <div class="site-wrap">
      <div class="site-navbar bg-white py-2">
        <div class="search-wrap">
          <div class="container">
            <a href="#" class="search-close js-search-close"><span class="icon-close2"></span></a>
            <form action="#" method="post">
              <input type="text" class="form-control" placeholder="Search keyword and hit enter...">
            </form>  
          </div>
        </div>

        <div class="container">
          <div class="d-flex align-items-center justify-content-between">
            <div class="logo">
              <div class="site-logo">
                <a href="/" class="js-logo-clone">LUSH SCENTES</a>
              </div>
            </div>
            <div class="main-nav d-none d-lg-block">
              <nav class="site-navigation text-right text-md-center" role="navigation">
                <ul class="site-menu js-clone-nav d-none d-lg-block">
                  <li class="has-children">
                    <a href="/">Home</a>
                    <ul class="dropdown">
                      <li><a href="#">Menu One</a></li>
                      <li><a href="#">Menu Two</a></li>
                      <li><a href="#">Menu Three</a></li>
                      <li class="has-children">
                        <a href="#">Sub Menu</a>
                        <ul class="dropdown">
                          <li><a href="#">Menu One</a></li>
                          <li><a href="#">Menu Two</a></li>
                          <li><a href="#">Menu Three</a></li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                  <li class="active"><a href="/shop">Shop</a></li>
                </ul>
              </nav>
            </div>
            <div class="icons">
              <a href="#" class="icons-btn d-inline-block js-search-open"><span class="icon-search"></span></a>
              <a href="/userProfile" class="icons-btn d-inline-block js-profile-open">
                <span class="icon-user"></span>
              </a>
              <a href="#" class="icons-btn d-inline-block"><span class="icon-heart-o"></span></a>
              <a href="/cart" class="icons-btn d-inline-block bag">
                <span class="icon-shopping-bag"></span>
              </a>
              <a href="#" class="site-menu-toggle js-menu-toggle ml-3 d-inline-block d-lg-none"><span class="icon-menu"></span></a>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-light py-3">
        <div class="container">
          <div class="row">
            <div class="col-md-12 mb-0">
              <a href="/">Home</a> <span class="mx-2 mb-0">/</span>
              <a href="/shop">Shop</a> <span class="mx-2 mb-0">/</span>
              <strong class="text-black">Product Details</strong>
            </div>
          </div>
        </div>
      </div>  

      <div class="site-section">
        <div class="container">
          <div class="row">
            <div class="col-md-6">
              <div class="item-entry">
                <div class="product-image-zoom">
                  <% if (product.productImage && product.productImage.length > 0) { %>
                    <% if (product.productImage[0].startsWith('http')) { %>
                      <img src="<%= product.productImage[0] %>" alt="<%= product.productName %>" class="img-fluid main-image">
                    <% } else { %>
                      <img src="/uploads/product-image/<%= product.productImage[0] %>" alt="<%= product.productName %>" class="img-fluid main-image">
                    <% } %>
                  <% } else { %>
                    <img src="/images/placeholder.jpg" alt="Product image not available" class="img-fluid main-image">
                  <% } %>
                </div>

                <div class="product-thumbnails mt-4">
                  <div class="row">
                    <% if (product.productImage && product.productImage.length > 0) { %>
                      <% product.productImage.forEach((image, index) => { %>
                        <div class="col-3">
                          <% if (image.startsWith('http')) { %>
                            <img src="<%= image %>" 
                                 alt="Thumbnail <%= index + 1 %>" 
                                 class="img-fluid thumbnail-image cursor-pointer"
                                 onclick="changeMainImage(this.src)">
                          <% } else { %>
                            <img src="/uploads/product-image/<%= image %>" 
                                 alt="Thumbnail <%= index + 1 %>" 
                                 class="img-fluid thumbnail-image cursor-pointer"
                                 onclick="changeMainImage(this.src)">
                          <% } %>
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h2 class="text-black"><%= product.productName %></h2>
              <p><%= product.description %></p>
              <p class="mb-4"><%= category.description %></p>

            
             
<% if (appliedOffer) { %>
  <div class="offer-container mb-3">
    <div class="offer-header">
      <span class="offer-icon">üéÅ</span>
      <span class="offer-type">
        <%= offerType === 'product' ? 'Product Offer' : 'Category Offer' %>
      </span>
    </div>
    <div class="offer-details">
      <span class="offer-name"><%= appliedOffer %></span>
      <span class="offer-discount"> - <%= highestDiscount %>% Off</span>
    </div>
  </div>
<% } else { %>
  <p class="text-muted mb-3">No offers available for this product.</p>
<% } %>

              <!-- Price Display -->
              <div id="price-display">
                <h3>
                  <% if (product.variants && product.variants.length > 0) { 
                    const defaultVariant = product.variants[0]; %>
                    <strong class="item-price">
                      <% if (defaultVariant.discountedPrice && defaultVariant.discountPercentage > 0) { %>
                        <del>‚Çπ<%= defaultVariant.regularPrice %></del> ‚Çπ<%= defaultVariant.discountedPrice %>
                      <% } else { %>
                        ‚Çπ<%= defaultVariant.regularPrice %>
                      <% } %>
                    </strong>
                  <% } %>
                </h3>
              </div>

              <div class="row mt-3">
                <div class="col-md-12">
                  <h5 style="color: black;"><strong>Reviews</strong></h5>
                  <p>
                    <% if (averageRating > 0) { %>
                      <% for (let i = 0; i < 5; i++) { %>
                        <% if (i < Math.floor(averageRating)) { %>
                          <span class="icon-star2 text-warning"></span>
                        <% } else if (i < averageRating && i >= Math.floor(averageRating)) { %>
                          <span class="icon-star-half text-warning"></span>
                        <% } else { %>
                          <span class="icon-star-o text-muted"></span>
                        <% } %>
                      <% } %>
                      (<%= averageRating %> based on <%= product.reviews.length %> review<%= product.reviews.length !== 1 ? 's' : '' %>)
                    <% } else { %>
                      No reviews yet.
                    <% } %>
                  </p>
                </div>
              </div>

              <div class="product-variants mt-4">
  <h5 class="mb-3">Product Variants</h5>
  <% if (product.variants && product.variants.length > 0) { %>
    <div class="variant-selection mb-4">
      <div class="form-group">
        <label for="size-selector">Size</label>
        <select id="size-selector" class="form-control">
          <option value="">Select Size</option>
          <% product.variants.forEach(data => { %>
            <option 
              value="<%= data.size %>" 
              data-regular-price="<%= data.regularPrice %>" 
              data-discounted-price="<%= data.discountedPrice || data.regularPrice %>" 
              data-quantity="<%= data.quantity %>">
              <%= data.size %>
            </option>
          <% }); %>
        </select>
      </div>

      <div class="form-group mt-3">
        <label for="quantity">Quantity</label>
        <div class="input-group" style="max-width: 150px;">
          <div class="input-group-prepend">
            <button class="btn btn-outline-primary js-btn-minus" type="button">‚àí</button>
          </div>
          <input type="text" id="quantity" class="form-control text-center" value="1" min="1" max="5" placeholder="Enter quantity" aria-label="Quantity" aria-describedby="button-addon1">
          <div class="input-group-append">
            <button class="btn btn-outline-primary js-btn-plus" type="button">+</button>
          </div>
        </div>
        <p id="variant-stock" class="text-muted mt-2" data-initial-stock="0">Select a size to see available stock</p>
      </div>
    </div>
  <% } %>
</div>

              <p>
                <button 
                  class="buy-now btn btn-sm height-auto px-4 py-3 btn-primary" 
                  onclick="handleAddToCart('<%= product._id %>')">
                  Add To Cart
                </button>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Write a Review Section -->
    <div class="container">
      

      <!-- Customer Reviews Section -->
      <div class="row mt-5">
        <div class="col-md-12">
          <div class="customer-reviews-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">Customer Reviews</h4>
              <% if (product.reviews && product.reviews.length > 0) { %>
                <span class="badge bg-primary rounded-pill"><%= product.reviews.length %> Review<%= product.reviews.length > 1 ? 's' : '' %></span>
              <% } %>
            </div>
            
            <% if (product.reviews && product.reviews.length > 0) { %>
              <div class="reviews-list">
                <% product.reviews.forEach(review => { %>
                  <div class="review-card mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between">
                      <div class="reviewer-info">
                        <h6 class="mb-0 fw-bold"><%= review.name %></h6>
                        <small class="text-muted"><%= review.email %></small>
                      </div>
                      <div class="review-date">
                        <small class="text-muted"><%= review.createdAt.toLocaleDateString() %></small>
                      </div>
                    </div>
                    <div class="rating-stars my-2">
                      <% for (let i = 0; i < 5; i++) { %>
                        <% if (i < review.rating) { %>
                          <i class="icon-star2 text-warning"></i>
                        <% } else { %>
                          <i class="icon-star-o text-muted"></i>
                        <% } %>
                      <% } %>
                    </div>
                    <p class="review-text mb-0"><%= review.review %></p>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <div class="text-center p-4 border rounded bg-light">
                <p class="text-muted mb-0">No reviews yet. Be the first to review this product!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="site-section block-3 site-blocks-2">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-7 site-section-heading text-center pt-4">
            <h2>Related Products</h2>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 block-3">
            <div class="nonloop-block-3 owl-carousel">
              <% relatedProduct.forEach(product => { %>
                <div class="item">
                  <div class="item-entry">
                    <a href="/productDetailsPage?id=<%= product._id %>" class="product-item md-height bg-gray d-block">
                      <img src="<%= product.productImage[0] %>" alt="Image" class="img-fluid">
                    </a>
                    <h2 class="item-title">
                      <a href="/productDetailsPage?id=<%= product._id %>"><%= product.productName %></a>
                    </h2>
                    <% if (product.variants && product.variants.length > 0) { %>
                      <strong class="item-price">
                        <del>‚Çπ<%= product.variants[0].regularPrice %></del> 
                        ‚Çπ<%= product.variants[0].salesPrice || product.variants[0].regularPrice %>
                      </strong>
                    <% } %>
                    <div class="star-rating">
                      <span class="icon-star2 text-warning"></span>
                      <span class="icon-star2 text-warning"></span>
                      <span class="icon-star2 text-warning"></span>
                      <span class="icon-star2 text-warning"></span>
                      <span class="icon-star2 text-warning"></span>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="site-footer custom-border-top">
      <div class="container">
        <div class="row">
          <div class="col-md-6 col-lg-3 mb-4 mb-lg-0">
            <h3 class="footer-heading mb-4">Promo</h3>
            <a href="#" class="block-6">
              <img src="images/about_1.jpg" alt="Image placeholder" class="img-fluid rounded mb-4">
              <h3 class="font-weight-light mb-0">Finding Your Perfect Scents This Summer</h3>
              <p>Promo from July 15 ‚Äî 25, 2019</p>
            </a>
          </div>
          <div class="col-lg-5 ml-auto mb-5 mb-lg-0">
            <div class="row">
              <div class="col-md-12">
                <h3 class="footer-heading mb-4">Quick Links</h3>
              </div>
              <div class="col-md-6 col-lg-4">
                <ul class="list-unstyled">
                  <li><a href="#">Sell online</a></li>
                  <li><a href="#">Features</a></li>
                  <li><a href="#">Shopping cart</a></li>
                  <li><a href="#">Store builder</a></li>
                </ul>
              </div>
              <div class="col-md-6 col-lg-4">
                <ul class="list-unstyled">
                  <li><a href="#">Mobile commerce</a></li>
                  <li><a href="#">Dropshipping</a></li>
                  <li><a href="#">Website development</a></li>
                </ul>
              </div>
              <div class="col-md-6 col-lg-4">
                <ul class="list-unstyled">
                  <li><a href="#">Point of sale</a></li>
                  <li><a href="#">Hardware</a></li>
                  <li><a href="#">Software</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="block-5 mb-5">
              <h3 class="footer-heading mb-4">Contact Info</h3>
              <ul class="list-unstyled">
                <li class="address">203 Fake St. Mountain View, San Francisco, California, USA</li>
                <li class="phone"><a href="tel://23923929210">+2 392 3929 210</a></li>
                <li class="email">emailaddress@domain.com</li>
              </ul>
            </div>
            <div class="block-7">
              <form action="#" method="post">
                <label for="email_subscribe" class="footer-heading">Subscribe</label>
                <div class="form-group">
                  <input type="text" class="form-control py-4" id="email_subscribe" placeholder="Email">
                  <input type="submit" class="btn btn-sm btn-primary" value="Send">
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="row pt-5 mt-5 text-center">
          <div class="col-md-12">
            <p>
              Copyright ¬©<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="icon-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank" class="text-primary">Colorlib</a>
            </p>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-zoom/1.7.21/jquery.zoom.min.js"></script>



  <script>
  $(document).ready(function() {
    if ($('.product-image-zoom').length) {
      $('.product-image-zoom').zoom({
        magnify: 1.5
      });
    }

    $('.js-btn-plus').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); 
        var input = $(this).closest('.input-group').find('input#quantity');
        var value = parseInt(input.val());
        var maxPurchaseLimit = 5;
        var stockLimit = parseInt(input.attr('max-stock')) || 0;

        if (isNaN(value)) value = 0; 

        if (value < maxPurchaseLimit && value < stockLimit) {
            input.val(value + 1);
            updateStockDisplay();
        } else if (value >= maxPurchaseLimit) {
            Swal.fire({
                title: 'Limit Reached',
                text: 'You can only purchase up to 5 items.',
                icon: 'warning',
                confirmButtonColor: '#3085d6'
            });
        } else if (value >= stockLimit) {
            Swal.fire({
                title: 'Stock Limit Reached',
                text: 'You cannot select more than the available stock.',
                icon: 'warning',
                confirmButtonColor: '#3085d6'
            });
        }
    });

    $('.js-btn-minus').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var input = $(this).closest('.input-group').find('input#quantity');
        var value = parseInt(input.val());
        if (value > 1) {
            input.val(value - 1);
            updateStockDisplay();
        }
    });

    $('#quantity').on('input', function() {
      var value = parseInt($(this).val());
      var maxPurchaseLimit = 5;
      var stockLimit = parseInt($(this).attr('max-stock'));

      if (isNaN(value) || value < 1) {
        $(this).val(1);
      } else if (value > maxPurchaseLimit) {
        $(this).val(maxPurchaseLimit);
        Swal.fire({
          title: 'Limit Reached',
          text: 'You can only purchase up to 5 items.',
          icon: 'warning',
          confirmButtonColor: '#3085d6'
        });
      } else if (value > stockLimit) {
        $(this).val(stockLimit);
        Swal.fire({
          title: 'Stock Limit Reached',
          text: 'You cannot select more than the available stock.',
          icon: 'warning',
          confirmButtonColor: '#3085d6'
        });
      }
      updateStockDisplay();
    });

    $('#size-selector').change(function() {
      updatePriceAndStock($(this));
    });

    if ($('#size-selector').val()) {
      updatePriceAndStock($('#size-selector'));
    }
  });

  function updatePriceAndStock(sizeSelector) {
    const selectedOption = sizeSelector.find('option:selected');
    
    if (!selectedOption.val()) {
      $('#variant-stock').text('Select a size to see available stock').attr('data-initial-stock', 0);
      $('#quantity').val(1);
      return;
    }
    
    const regularPrice = selectedOption.data('regular-price');
    const discountedPrice = selectedOption.data('discounted-price');
    const quantity = selectedOption.data('quantity') || 0;
    
    if (discountedPrice && discountedPrice != regularPrice) {
      $('#price-display').html(`
        <h3>
          <strong class="item-price">
            <del>‚Çπ${regularPrice}</del> ‚Çπ${discountedPrice}
          </strong>
        </h3>
      `);
    } else {
      $('#price-display').html(`
        <h3>
          <strong class="item-price">‚Çπ${regularPrice}</strong>
        </h3>
      `);
    }
    
    $('#variant-stock').attr('data-initial-stock', quantity);
    $('#quantity').attr('max-stock', quantity);
    updateStockDisplay();
  }

  function updateStockDisplay() {
    const initialStock = parseInt($('#variant-stock').attr('data-initial-stock'));
    const selectedQuantity = parseInt($('#quantity').val()) || 1;
    
    if (isNaN(initialStock) || initialStock === 0) {
        $('#variant-stock').text('Out of Stock');
        $('#quantity').val(0).prop('disabled', true); 
        $('.js-btn-plus, .js-btn-minus').prop('disabled', true); 
        return;
    }

  const remainingStock = initialStock - selectedQuantity;
    if (remainingStock < 0) {
        $('#variant-stock').text('Out of Stock');
        $('#quantity').val(initialStock); // Set to max available
    } else {
        $('#variant-stock').text(`Stock: ${remainingStock}`);
        $('#quantity').prop('disabled', false);
        $('.js-btn-plus, .js-btn-minus').prop('disabled', false);
    }
}

  function changeMainImage(src) {
    $('.main-image').attr('src', src);
    if ($('.product-image-zoom').length) {
      $('.product-image-zoom').trigger('zoom.destroy');
      $('.product-image-zoom').zoom({
        magnify: 1.5
      });
    }
  }

  async function handleAddToCart(productId) {
    try {
      const sizeSelect = document.getElementById('size-selector');
      const quantityInput = document.getElementById('quantity');

      if (!sizeSelect.value) {
        await Swal.fire({
          title: 'Selection Required',
          text: 'Please select a size',
          icon: 'warning',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      const quantity = parseInt(quantityInput.value);
      if (isNaN(quantity) || quantity < 1) {
        await Swal.fire({
          title: 'Invalid Quantity',
          text: 'Please enter a valid quantity',
          icon: 'warning',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      const payload = {
        productId: productId,
        variant: {
          size: sizeSelect.value,
          quantity: quantity
        }
      };

      const response = await fetch('/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Failed to add to cart');
      }

      if (data.cart) {
        const cartCount = data.cart.items.reduce((sum, item) => sum + item.variant.quantity, 0);
        const cartCountElement = document.querySelector('.bag .number');
        if (cartCountElement) {
          cartCountElement.textContent = cartCount;
        }
      }

      await Swal.fire({
        title: 'Success!',
        text: data.message || 'Product added to cart successfully!',
        icon: 'success',
        confirmButtonColor: '#3085d6'
      });

    } catch (error) {
      console.error('Error:', error);
      await Swal.fire({
        title: 'Error!',
        text: error.message || 'Error adding to cart',
        icon: 'error',
        confirmButtonColor: '#3085d6'
      });
    }
  }

  $(document).ready(function () {
    $('#reviewForm').submit(function (e) {
      e.preventDefault();
      const formData = {
        productId: $('input[name="productId"]').val(),
        review: $('#review').val(),
        rating: $('#rating').val(),
      };

      $.ajax({
        url: '/productDetailsPage/review',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
          if (response.success) {
            Swal.fire({
              title: 'Success!',
              text: response.message,
              icon: 'success',
              confirmButtonColor: '#3085d6',
            }).then(() => {
              const averageRatingElement = $('.reviews-rating');
              if (averageRatingElement.length) {
                let stars = '';
                for (let i = 0; i < 5; i++) {
                  if (i < Math.floor(response.averageRating)) {
                    stars += '<span class="icon-star2 text-warning"></span>';
                  } else if (i < response.averageRating && i >= Math.floor(response.averageRating)) {
                    stars += '<span class="icon-star-half text-warning"></span>';
                  } else {
                    stars += '<span class="icon-star-o text-muted"></span>';
                  }
                }
                averageRatingElement.html(`${stars} (${response.averageRating} based on ${parseInt(averageRatingElement.text().match(/\d+/) || 0) + 1} reviews)`);
              }

              const reviewsList = $('.reviews-list');
              if (reviewsList.length) {
                const newReviewHtml = `
                  <div class="review-card mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between">
                      <div class="reviewer-info">
                        <h6 class="mb-0 fw-bold">${response.newReview.name}</h6>
                        <small class="text-muted">${response.newReview.email}</small>
                      </div>
                      <div class="review-date">
                        <small class="text-muted">${new Date().toLocaleDateString()}</small>
                      </div>
                    </div>
                    <div class="rating-stars my-2">
                      ${Array(response.newReview.rating).fill('<i class="icon-star2 text-warning"></i>').join('')}${Array(5 - response.newReview.rating).fill('<i class="icon-star-o text-muted"></i>').join('')}
                    </div>
                    <p class="review-text mb-0">${response.newReview.review}</p>
                  </div>
                `;
                reviewsList.append(newReviewHtml);

                const badge = $('.badge.bg-primary');
                if (badge.length) {
                  const currentCount = parseInt(badge.text()) || 0;
                  badge.text(`${currentCount + 1} Review${currentCount + 1 > 1 ? 's' : ''}`);
                }
              }

              $('#reviewForm')[0].reset();
            });
          } else {
            Swal.fire({
              title: 'Error!',
              text: response.message,
              icon: 'error',
              confirmButtonColor: '#3085d6',
            });
          }
        },
        error: function (err) {
          Swal.fire({
            title: 'Error!',
            text: 'An error occurred while submitting your review.',
            icon: 'error',
            confirmButtonColor: '#3085d6',
          });
        },
      });
    });
  });
</script>
</body>
</html>